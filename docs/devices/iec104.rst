IEC 60870-5-104 devices
=======================

Together with IEC104 specific events, generic `enable` and `running` events
are also supported.

IEC104 device configurations and event payloads are defined by:

    .. literalinclude:: ../../schemas_json/iec104.yaml
        :language: yaml


IEC104 master device
--------------------

IEC master device configuration is specified by
``hat-gateway://iec104.yaml#/definitions/master``.

According to :ref:`gateway specification <gateway>`, all IEC104 master device
event types have prefix::

    'gateway', <gateway_name>, 'iec104_master', <device_name>, <source>, ...

.. todo::

    * reconnect procedure when device is enabled (reconnect delay)
    * iec104 asdu messages are sent to device only as reaction to
      `system` events
    * only "automatic" driver action is reconnect loop
    * new `gateway` events are generated only as reaction to:
        - receiving iec104 asdu messages
        - change of connection state
    * messages with test flag are ignored

To enable communication between IEC104 master device and rest of the hat
system, following event types are used:

    * 'gateway', <gateway_name>, 'iec104_master', <device_name>, 'gateway', ...

        * ..., 'status'

            Represents change in connection status. Upon enabling device,
            new ``CONNECTING`` status should be registered. Once device is
            disabled, ``DISCONNECTED`` status should be assumed regardless
            of last registered `status` event (registration of
            ``DISCONNECTED`` status event during device disabling is mandatory
            but should not be relied upon).

            Source timestamp is ``None``.

            Payload is specified by
            ``hat-gateway://iec104.yaml#/definitions/events/master/gateway/status``.

            .. todo::

                * do we need DISCONNECTING

        * ..., 'data', <asdu_address>, <io_address>

            Represents received IEC104 data message.

            Source timestamp is dependent on existence of IEC104 time.
            If IEC104 time is not available, source timestamp is ``None``.

            Payload is specified by
            ``hat-gateway://iec104.yaml#/definitions/events/master/gateway/data``.

            .. todo::

                * should we add data type to event type
                * do we need distinct interrogated causes

        * ..., 'command', <asdu_address>, <io_address>

            Represents received IEC104 command message.

            Source timestamp is dependent on existence of IEC104 time.
            If IEC104 time is not available, source timestamp is ``None``.

            Payload is specified by
            ``hat-gateway://iec104.yaml#/definitions/events/master/gateway/command``.

            .. todo::

                * should we add command type to event type

        * ..., 'interrogation', <asdu_address>

            Represents received IEC104 end of interrogation message.

            Source timestamp is ``None``.

            Payload is ``None``.

            .. todo::

                * do we need qualifier

        * ..., 'counter_interrogation', <asdu_address>

            Represents received IEC104 end of counter interrogation message.

            Source timestamp is ``None``.

            Payload is ``None``.

            .. todo::

                * do we need freeze code
                * do we need request number

    * 'gateway', <gateway_name>, 'iec104_master', <device_name>, 'system', ...

        * ..., 'command', <asdu_address>, <io_address>

            Represents request for command execution.

            Source timestamp is ``None``.

            Payload is specified by
            ``hat-gateway://iec104.yaml#/definitions/events/master/system/command``.

        * ..., 'interrogation', <asdu_address>

            Represents request for interrogation.

            Source timestamp is ``None``.

            Payload is ``None``.

            .. todo::

                * do we need qualifier

        * ..., 'counter_interrogation', <asdu_address>

            Represents request for counter interrogation.

            Source timestamp is ``None``.

            Payload is ``None``.

            Payload is specified by
            ``hat-gateway://iec104.yaml#/definitions/events/master/system/counter_interrogation``.

            .. todo::

                * do we need request number


.. todo::

    * what to do when cause is None (discard message or return None cause)
